# Yaya Wallet Webhook Service

A Go web service that receives and processes webhook notifications from Yaya Wallet payment system with SQLite database storage.

## ğŸš€ Features

- âœ… Webhook signature verification (HMAC-SHA256)
- âœ… Timestamp validation (5-minute tolerance)
- âœ… SQLite file database for persistent storage
- âœ… Asynchronous webhook processing
- âœ… Health check endpoint
- âœ… Comprehensive logging

## ğŸ“‹ Prerequisites

- **Go 1.24+** installed on your system
- **SQLite3** (usually comes with Go)

## ğŸ› ï¸ Installation & Setup

### 1. Clone or Download the Project
```bash
git clone <your-repo-url>
cd yaya_wallet_webhook
```

### 2. Install Dependencies
```bash
go mod tidy
```

### 3. Create Configuration File
Copy the example configuration and customize it:
```bash
touch example_config.yaml
```

Edit `example_config.yaml` with your settings:
```yaml
secret_key: secret
port: 8080
timeout: 30s

# Database configuration
database:
  file: "./yaya_webhooks.db"
```

## ğŸš€ Starting the Server

###  Using `go run` (Development)
```bash
# Run directly with Go
go run .
```

## ğŸ“¡ Server Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| `GET` | `/healthcheck` | Health check endpoint |
| `POST` | `/webhook` | Webhook receiver |

### 1. Health Check Endpoint

**Request:**
```bash
curl http://localhost:8080/healthcheck
```

**Response:**
```json
{
  "status_code": 200,
  "message": "Server is up and running"
}
```

### 2. Webhook Endpoint

**Request:**
```bash
curl -X POST http://localhost:8080/webhook \
  -H "Content-Type: application/json" \
  -H "YAYA-SIGNATURE: YOUR_SIGNATURE_HERE" \
  -d '{
    "id": "webhook-id-123",
    "amount": "100.50",
    "currency": "ETB",
    "created_at_time": 1703123456,
    "timestamp": 1703123456,
    "cause": "Payment for services",
    "full_name": "John Doe",
    "account_name": "john@example.com",
    "invoice_url": "https://example.com/invoice/123"
  }'
```

**Success Response:**
```json
{
  "status_code": 200,
  "message": "Webhook received successfully"
}
```

**Error Responses:**

*Missing Signature:*
```json
{
  "status_code": 400,
  "error": "signature is missing"
}
```

*Invalid Signature:*
```json
{
  "status_code": 400,
  "error": "invalid signature"
}
```

*Invalid Timestamp:*
```json
{
  "status_code": 400,
  "error": "invalid timestamp"
}
```

*Invalid Data:*
```json
{
  "status_code": 400,
  "error": "invalid data"
}
```

## ğŸ§ª Testing the Service

### 1. Health Check
```bash
curl http://localhost:8080/healthcheck
```

Expected response:
```json
{"status_code":200,"message":"Server is up and running"}
```

### 2. Send a Webhook
Use the signature generation script:
```bash
# Make executable
chmod +x generate_payload_signature.sh

# Generate signature and test command
./generate_payload_signature.sh
```

The script will output a complete curl command with:
- Fresh random UUID
- Current timestamp
- Valid signature
- Proper JSON payload

## ğŸ” Webhook Signature

The service validates webhooks using HMAC-SHA256 signatures. The signature is generated by concatenating all webhook fields in this order:

```
ID + Amount + Currency + CreatedAtTime + Timestamp + Cause + FullName + AccountName + InvoiceURL
```

### Example Signature Generation
```bash
# Using the provided script
./generate_payload_signature.sh

# Manual generation (if needed)
echo -n "your_concatenated_string" | openssl dgst -sha256 -hmac "your_secret_key" | cut -d' ' -f2
```

## ğŸ—„ï¸ Database

- **Type**: SQLite file database
- **File**: `./yaya_webhooks.db` (configurable)
- **Table**: `webhooks`
- **Persistence**: Data survives service restarts

### Database Schema
```sql
CREATE TABLE webhooks (
    id TEXT PRIMARY KEY,
    amount TEXT,
    currency TEXT,
    created_at_time INTEGER,
    timestamp INTEGER,
    cause TEXT,
    full_name TEXT,
    account_name TEXT,
    invoice_url TEXT,
    created_at DATETIME,
    updated_at DATETIME
);
```

## âš™ï¸ Configuration

### Environment Variables
- `CONFIG_FILE`: Path to configuration file (default: `./example_config.yaml`)

### Configuration Options
| Key | Type | Default | Description |
|-----|------|---------|-------------|
| `secret_key` | string | `secret` | Secret key for signature verification |
| `port` | string | `8080` | Server port |
| `timeout` | duration | `30s` | Graceful shutdown timeout |
| `database.file` | string | `./yaya_webhooks.db` | SQLite database file path |

## ğŸ” Debugging

### Enable Debug Logging
The service logs all operations in JSON format. Look for:
- Configuration initialization
- Webhook processing steps
- Signature validation details
- Database operations
- Error messages


## ğŸ“ Project Structure

```
yaya_wallet_webhook/
â”œâ”€â”€ main.go                 # Server setup and configuration
â”œâ”€â”€ handler.go              # Webhook handling logic
â”œâ”€â”€ model.go                # Data structures
â”œâ”€â”€ example_config.yaml             # Your configuration (create this)
â”œâ”€â”€ generate_payload_signature.sh  # Signature generation script
â”œâ”€â”€ go.mod                  # Go module file
â”œâ”€â”€ go.sum                  # Go dependencies checksum
â””â”€â”€ README.md               # This file
```

**Happy coding! ğŸ‰**
